<script>
    // --- 背景動畫邏輯 (這部分不用動，維持原樣) ---
    function randomPop() {
        const moles = document.querySelectorAll('.pixel-mole');
        moles.forEach(m => m.classList.remove('is-active'));
        
        // 隨機讓 1~2 隻地鼠跳起來，當作背景氣氛
        const randomIndex = Math.floor(Math.random() * 9);
        moles[randomIndex].classList.add('is-active');
        
        setTimeout(randomPop, 1500 + Math.random() * 1000);
    }
    setTimeout(randomPop, 1000);

    // --- Arduino 連線邏輯 (升級版) ---
    let port;
    let reader;
    
    document.getElementById('connectBtn').addEventListener('click', async () => {
        // 檢查瀏覽器支援度
        if (!("serial" in navigator)) {
            alert("請使用 Chrome 或 Edge 瀏覽器");
            return;
        }

        try {
            port = await navigator.serial.requestPort();
            await port.open({ baudRate: 9600 });
            
            // UI 更新
            const btn = document.getElementById('connectBtn');
            btn.textContent = "CONNECTED";
            btn.style.background = "#4cd137";
            btn.style.color = "#000";
            btn.disabled = true;

            readStream();
        } catch (e) { 
            console.error(e);
            alert("連線失敗或取消"); 
        }
    });

    async function readStream() {
        const textDecoder = new TextDecoderStream();
        const readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
        const reader = textDecoder.readable.getReader();
        
        let buffer = ""; // 暫存區

        while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            
            if (value) {
                buffer += value; // 把收到的碎片拼起來
                
                // 檢查有沒有換行符號 (代表一句話講完了)
                let lines = buffer.split('\n');
                buffer = lines.pop(); // 把最後一句可能不完整的留著，下次拼
                
                for (const line of lines) {
                    processArduinoData(line.trim());
                }
            }
        }
    }

    // 處理 Arduino 傳來的指令
    function processArduinoData(data) {
        console.log("收到:", data); // Debug 用

        if (data.startsWith("LIVE_SCORE:")) {
            const score = data.split(":")[1];
            // 加上補零效果 (0 -> 00)
            document.getElementById('liveScore').innerText = score.padStart(2, '0');
        }
        else if (data.startsWith("GAME_OVER_SCORE:")) {
             const score = data.split(":")[1];
             document.getElementById('liveScore').style.color = "red"; // 結束變紅字
        }
        else if (data === "GAME_START") {
             document.getElementById('liveScore').style.color = "#00ff00"; // 開始變綠字
             document.getElementById('liveScore').innerText = "00";
        }
    }
</script>
