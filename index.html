<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CYBER WHAC-A-MOLE | æ•¸ä½æ‰“åœ°é¼ ç³»çµ±</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --neon-blue: #00f3ff;
            --neon-purple: #bc13fe;
            --bg-dark: #050a10;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-dark);
            /* ç§‘æŠ€æ„Ÿæ‰“åœ°é¼ èƒŒæ™¯ï¼šéœ“è™¹å­”æ´ç‰¹æ•ˆ */
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(0, 243, 255, 0.15) 0%, transparent 20%),
                radial-gradient(circle at 80% 30%, rgba(188, 19, 254, 0.15) 0%, transparent 20%),
                radial-gradient(circle at 50% 70%, rgba(0, 243, 255, 0.1) 0%, transparent 25%),
                linear-gradient(rgba(0, 243, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.05) 1px, transparent 1px);
            background-size: 100% 100%, 100% 100%, 100% 100%, 40px 40px, 40px 40px;
            color: white;
            font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            background: rgba(10, 20, 30, 0.85);
            border: 2px solid var(--neon-blue);
            box-shadow: 0 0 25px rgba(0, 243, 255, 0.3), inset 0 0 15px rgba(0, 243, 255, 0.1);
            border-radius: 20px;
            padding: 40px;
            width: 450px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        h1 {
            text-transform: uppercase;
            letter-spacing: 4px;
            color: var(--neon-blue);
            text-shadow: 0 0 10px var(--neon-blue);
            margin-bottom: 30px;
        }

        .score-display {
            font-size: 4rem;
            font-weight: bold;
            color: var(--neon-purple);
            text-shadow: 0 0 20px var(--neon-purple);
            margin: 20px 0;
        }

        .status-tag {
            font-size: 0.9rem;
            padding: 5px 15px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
            display: inline-block;
        }

        button {
            background: transparent;
            border: 1px solid var(--neon-blue);
            color: var(--neon-blue);
            padding: 12px 30px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-top: 10px;
        }

        button:hover {
            background: var(--neon-blue);
            color: black;
            box-shadow: 0 0 20px var(--neon-blue);
        }

        .leaderboard {
            margin-top: 40px;
            border-top: 1px solid rgba(0, 243, 255, 0.3);
            padding-top: 20px;
            text-align: left;
        }

        .rank-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .rank-item:last-child { border: none; }
        .gold { color: #ffd700; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>Cyber Mole</h1>
    <div class="status-tag" id="status">è£ç½®ï¼šç­‰å¾…é€£ç·š</div>
    
    <div class="score-display" id="liveScore">00</div>
    
    <button id="connectBtn">åˆå§‹åŒ–ç¥ç¶“é€£çµ (USB Connect)</button>

    <div class="leaderboard">
        <h3 style="color: var(--neon-blue); font-size: 0.9rem; letter-spacing: 2px;">ğŸ† å…¨çƒé ‚å°–åˆ†æ•¸</h3>
        <div id="rankBody">è¼‰å…¥ä¸­...</div>
    </div>
</div>

<script>
    // --- STEP 1: Firebase è¨­å®š (è«‹åœ¨æ­¤è²¼ä¸Šä½ è‡ªå·±çš„é‡‘é‘°) ---
    const firebaseConfig = {
        apiKey: "ä½ çš„API_KEY",
        authDomain: "ä½ çš„å°ˆæ¡ˆ.firebaseapp.com",
        projectId: "ä½ çš„å°ˆæ¡ˆID",
        storageBucket: "ä½ çš„å°ˆæ¡ˆ.appspot.com",
        messagingSenderId: "ä½ çš„å‚³é€è€…ID",
        appId: "ä½ çš„APP_ID"
    };
    
    // åˆå§‹åŒ– Firebase (å¦‚æœæ²’è¨­å®šé‡‘é‘°ï¼Œæ’è¡Œæ¦œæœƒå ±éŒ¯ä½†é€£ç·šåŠŸèƒ½ä»å¯ç”¨)
    try {
        firebase.initializeApp(firebaseConfig);
        var db = firebase.firestore();
    } catch(e) { console.log("Firebase æœªè¨­å®š"); }

    // --- STEP 2: Web Serial Arduino é€£ç·š ---
    let port;
    const connectBtn = document.getElementById('connectBtn');
    const scoreText = document.getElementById('liveScore');
    const statusTag = document.getElementById('status');

    connectBtn.addEventListener('click', async () => {
        try {
            port = await navigator.serial.requestPort();
            await port.open({ baudRate: 9600 });
            statusTag.innerText = "è£ç½®ï¼šå·²é€£ç·š (Online)";
            statusTag.style.color = "#00ff00";
            connectBtn.style.display = 'none';
            readStream();
        } catch (err) {
            alert("é€£ç·šå¤±æ•—ï¼Œè«‹ç¢ºä¿ä½¿ç”¨ Chrome ä¸¦æ¥ä¸Š Arduino");
        }
    });

    async function readStream() {
        const textDecoder = new TextDecoderStream();
        const readableStreamClosed = port.readable.pipeTo(textDecoder.writable);
        const reader = textDecoder.readable.getReader();

        while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            if (value) {
                // è™•ç†å³æ™‚åˆ†æ•¸
                if (value.includes("LIVE_SCORE:")) {
                    const s = value.split(":")[1].trim();
                    scoreText.innerText = s.padStart(2, '0');
                }
                // è™•ç†éŠæˆ²çµæŸ
                if (value.includes("GAME_OVER_SCORE:")) {
                    const finalS = parseInt(value.split(":")[1]);
                    saveToCloud(finalS);
                }
            }
        }
    }

    // --- STEP 3: æ’è¡Œæ¦œè™•ç† ---
    async function saveToCloud(score) {
        const name = prompt(`éŠæˆ²çµæŸï¼åˆ†æ•¸ï¼š${score}\nè«‹è¼¸å…¥ä½ çš„ç‰¹å·¥ä»£è™Ÿï¼š`) || "åŒ¿åé»‘å®¢";
        if (db) {
            await db.collection("leaderboard").add({
                name: name,
                score: score,
                time: firebase.firestore.FieldValue.serverTimestamp()
            });
            updateRank();
        }
    }

    function updateRank() {
        if (!db) return;
        db.collection("leaderboard").orderBy("score", "desc").limit(5).onSnapshot(snap => {
            const body = document.getElementById('rankBody');
            body.innerHTML = snap.docs.map((doc, i) => `
                <div class="rank-item ${i===0?'gold':''}">
                    <span>${i+1}. ${doc.data().name}</span>
                    <span>${doc.data().score} PTS</span>
                </div>
            `).join('');
        });
    }

    updateRank(); // åˆå§‹åŒ–æ’è¡Œæ¦œ
</script>

</body>
</html>
