<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CYBER MOLE | 核心系統</title>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --neon: #00f3ff; --bg: #050505; --panel: #111; }
        body { background: var(--bg); color: white; font-family: 'Orbitron', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .dashboard { width: 90%; max-width: 600px; background: var(--panel); border: 1px solid var(--neon); box-shadow: 0 0 20px rgba(0,243,255,0.2); border-radius: 10px; padding: 30px; position: relative; }
        .glitch-title { font-size: 2.5rem; text-align: center; color: var(--neon); text-transform: uppercase; letter-spacing: 5px; margin-bottom: 20px; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #1a1a1a; padding: 20px; border-radius: 5px; border-left: 4px solid var(--neon); text-align: center; }
        .stat-val { font-size: 2rem; display: block; color: #fff; }
        .stat-label { font-size: 0.8rem; color: #888; text-transform: uppercase; }
        button { width: 100%; padding: 15px; background: transparent; border: 1px solid var(--neon); color: var(--neon); cursor: pointer; transition: 0.3s; font-weight: bold; }
        button:hover { background: var(--neon); color: #000; box-shadow: 0 0 15px var(--neon); }
        .leaderboard { margin-top: 30px; }
        .rank-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #222; font-family: monospace; }
        .rank-item:first-child { color: gold; font-weight: bold; border-bottom: 1px solid gold; }
    </style>
</head>
<body>

<div class="dashboard">
    <div class="glitch-title">Cyber Mole</div>
    
    <div class="stats-grid">
        <div class="stat-card">
            <span class="stat-label">當前分數</span>
            <span class="stat-val" id="score">00</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">系統狀態</span>
            <span class="stat-val" id="status" style="font-size: 1rem;">未連線</span>
        </div>
    </div>

    <button id="connectBtn">初始化神經連結 (Connect Arduino)</button>

    <div class="leaderboard">
        <div style="text-align:center; color: var(--neon); margin-bottom: 10px;">—— 頂尖黑客排行榜 ——</div>
        <div id="rankList">載入中...</div>
    </div>
</div>

<script>
    // --- STEP 1: Firebase 設定 (請替換為你的金鑰) ---
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT.firebaseapp.com",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_PROJECT.appspot.com",
        messagingSenderId: "YOUR_SENDER_ID",
        appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- STEP 2: Web Serial 連接邏輯 ---
    let port;
    const connectBtn = document.getElementById('connectBtn');
    
    connectBtn.onclick = async () => {
        try {
            port = await navigator.serial.requestPort();
            await port.open({ baudRate: 9600 });
            document.getElementById('status').innerText = "ONLINE";
            document.getElementById('status').style.color = "#00ff00";
            connectBtn.style.display = 'none';
            readLoop();
        } catch (e) { alert("連線失敗：" + e); }
    };

    async function readLoop() {
        const textDecoder = new TextDecoderStream();
        port.readable.pipeTo(textDecoder.writable);
        const reader = textDecoder.readable.getReader();
        while (true) {
            const { value, done } = await reader.read();
            if (value) {
                if (value.includes("LIVE_SCORE:")) {
                    document.getElementById('score').innerText = value.split(":")[1].trim();
                }
                if (value.includes("GAME_OVER_SCORE:")) {
                    const finalScore = parseInt(value.split(":")[1]);
                    handleGameOver(finalScore);
                }
            }
        }
    }

    // --- STEP 3: 雲端儲存與排行榜 ---
    async function handleGameOver(score) {
        const name = prompt(`遊戲結束！獲得 ${score} 分。請輸入玩家代號：`) || "未知黑客";
        await db.collection("leaderboard").add({
            name: name,
            score: score,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        loadLeaderboard();
    }

    function loadLeaderboard() {
        db.collection("leaderboard").orderBy("score", "desc").limit(5).onSnapshot(snap => {
            const list = document.getElementById('rankList');
            list.innerHTML = snap.docs.map((doc, i) => `
                <div class="rank-item">
                    <span>${i+1}. ${doc.data().name}</span>
                    <span>${doc.data().score} PTS</span>
                </div>
            `).join('');
        });
    }

    loadLeaderboard(); // 頁面載入時初始化排行榜
</script>
</body>
</html>
